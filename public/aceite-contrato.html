<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aceite de Contrato • Home Fest</title>
    <style>
      *{ box-sizing:border-box; }
      body{ margin:0; font: 500 14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f8fafc; color:#0b1220; }
      .wrap{ max-width: 980px; margin: 24px auto; padding: 0 18px; }
      .card{ background:#fff; border:1px solid #e5e7eb; border-radius: 16px; overflow:hidden; box-shadow: 0 6px 18px rgba(2,6,23,.06); }
      .top{ padding: 16px 16px; border-bottom:1px solid #eef2f7; display:flex; justify-content:space-between; align-items:center; gap: 12px; }
      .brand{ font-weight: 900; letter-spacing:.2px; }
      .muted{ color:#64748b; }
      .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; padding: 16px; }
      iframe{ width:100%; height: 72vh; border: 1px solid #eef2f7; border-radius: 12px; }
      label{ display:block; font-weight:800; margin: 10px 0 6px; }
      input{ width:100%; padding: 10px 12px; border-radius: 12px; border:1px solid #e5e7eb; font: inherit; }
      button{ width:100%; margin-top: 12px; padding: 12px 14px; border-radius: 12px; border:1px solid #0f172a; background:#0f172a; color:#fff; font-weight:900; cursor:pointer; }
      button:disabled{ opacity:.6; cursor:not-allowed; }
      .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(2,6,23,.92); color:#fff; padding: 10px 12px; border-radius: 12px; display:none; }
      @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } iframe{ height: 60vh; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="top">
          <div>
            <div class="brand">Home Fest</div>
            <div class="muted">Leia o contrato abaixo e confirme o aceite.</div>
          </div>
          <div class="muted" id="st">Carregando…</div>
        </div>

        <div class="grid">
          <div>
            <iframe id="preview" title="Contrato"></iframe>
            <div class="muted" style="margin-top:10px;">Se preferir, você pode imprimir ou salvar como PDF usando o menu do navegador.</div>
          </div>
          <div>
            <div style="font-weight:900; font-size:16px;">Aceite</div>
            <label>Nome completo</label>
            <input id="nome" placeholder="Seu nome" autocomplete="name" />
            <label>CPF/CNPJ (opcional)</label>
            <input id="doc" placeholder="Somente números" autocomplete="off" />
            <button id="btn">Aceitar contrato</button>
            <div class="muted" style="margin-top:10px;">Ao aceitar, você confirma que leu e concorda com os termos.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      function qs(k){ return new URLSearchParams(location.search).get(k); }
      function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2600); }

      const contratoId = qs('contrato');
      const token = qs('token');
      const st = document.getElementById('st');
      const preview = document.getElementById('preview');

      if(!contratoId || !token){
        if(st) st.textContent = 'Link inválido.';
      } else {
        if(preview) preview.src = `/api/contratos/aceite/render?contrato=${encodeURIComponent(contratoId)}&token=${encodeURIComponent(token)}`;
        if(st) st.textContent = 'Pronto para aceite.';
      }

      const btn = document.getElementById('btn');
      btn.addEventListener('click', async ()=>{
        if(!contratoId || !token) return;
        const nome = (document.getElementById('nome').value || '').trim();
        const documento = (document.getElementById('doc').value || '').trim();
        if(!nome){ toast('Informe seu nome.'); return; }
        btn.disabled = true;
        try{
          const res = await fetch('/api/contratos/aceite', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contrato_id: Number(contratoId), token, nome, documento })
          });
          const out = await res.json().catch(()=>null);
          if(res.ok && out && out.ok){
            toast(out.already ? 'Este contrato já foi aceito.' : 'Contrato aceito com sucesso!');
            if(st) st.textContent = 'Aceito.';
          } else {
            toast((out && out.message) ? out.message : 'Não foi possível concluir.');
          }
        }catch(e){
          toast('Erro de conexão.');
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
